[
  {
    "test_name": "partial_granularity_reduced",
    "comment": [ "Use transaction from tracer_info.json, with partial granularity set to 'reduced'",
      "We should drop the in-process span and keep the rest.",
      "The external span External/B2 under the in-process span should be re-parented to the root span."],
    "tracer_info":"tracer_info_standard.json",
    "partial_granularity_type": "reduced",
    "expected_spans": [
      {
        "root": {
          "parent": null,
          "agent_attrs": {
            "exact": {
              "nr.pg": true
            }
          }
        }
      },
      {
        "External/ServiceB1": {
          "parent": "root",
          "agent_attrs": {
            "exact": {
              "http.url": "serviceB",
              "non_essential_attr": "somevalue",
              "error.class": "errorclass1",
              "error.message": "errormessage1",
              "error.expected": true
            }
          },
          "user_attrs": {
            "exact": {
              "my_user_attr": "my_value"
            }
          }
        }
      },
      {
        "External/ServiceB2": {
          "parent": "root",
          "agent_attrs": {
            "exact": {
              "http.url": "serviceB",
              "error.class": "errorclass2",
              "error.message": "errormessage2",
              "error.expected": false
            }
          }
        }
      },
      {
        "External/ServiceC": {
          "parent": "root",
          "agent_attrs": {
            "exact": {
              "http.url": "serviceC",
              "cloud.account.id": "12345",
              "cloud.platform": "AWS",
              "cloud.region": "US-EAST-1",
              "cloud.resource_id": "67890",
              "db.instance": "MYDB",
              "db.system": "Postgres",
              "http.url": "http://url1/",
              "messaging.destination.name": "dest",
              "messaging.system": "MQS",
              "peer.hostname": "peer",
              "server.address": "server",
              "server.port": 80,
              "span.kind": "SPAN"
            }
          }
        }
      },
      {
        "Llm/SOMETHING/function": {
          "parent": "root",
          "agent_attrs": {
            "exact": {
              "http.url": "myllm"
            }
          }
        }
      },
      {
        "External/ServiceD": {
          "parent": "Llm/SOMETHING/function",
          "agent_attrs": {
            "exact": {
              "http.url": "serviceD"
            }
          }
        }
      }
    ],
    "unexpected_spans": ["inprocess"]
  },
  {
    "test_name": "partial_granularity_essential",
    "comment": [ "Use transaction from tracer_info.json, with partial granularity set to 'essential'",
      "We should drop the in-process span and keep the rest.",
      "The external span External/B2 under the in-process span should be re-parented to the root span.",
      "The non-essential attribute on External/B1 should be dropped"],
    "tracer_info":"tracer_info_standard.json",
    "partial_granularity_type": "essential",
    "expected_spans": [
      {
        "root": {
          "parent": null,
          "agent_attrs": {
            "exact": {
              "nr.pg": true
            }
          }
        }
      },
      {
        "External/ServiceB1": {
          "parent": "root",
          "agent_attrs": {
            "exact": {
              "http.url": "serviceB",
              "error.class": "errorclass1",
              "error.message": "errormessage1",
              "error.expected": true
            },
            "unexpected": ["non_essential_attr"]
          },
          "user_attrs": {
            "unexpected": ["my_user_attr"]
          }
        }
      },
      {
        "External/ServiceB2": {
          "parent": "root",
          "agent_attrs": {
            "exact": {
              "http.url": "serviceB",
              "error.class": "errorclass2",
              "error.message": "errormessage2",
              "error.expected": false
            }
          }
        }
      },
      {
        "External/ServiceC": {
          "parent": "root",
          "agent_attrs": {
            "exact": {
              "http.url": "serviceC",
              "cloud.account.id": "12345",
              "cloud.platform": "AWS",
              "cloud.region": "US-EAST-1",
              "cloud.resource_id": "67890",
              "db.instance": "MYDB",
              "db.system": "Postgres",
              "http.url": "http://url1/",
              "messaging.destination.name": "dest",
              "messaging.system": "MQS",
              "peer.hostname": "peer",
              "server.address": "server",
              "server.port": 80,
              "span.kind": "SPAN"
            }
          }
        }
      },
      {
        "Llm/SOMETHING/function": {
          "parent": "root",
          "agent_attrs": {
            "exact": {
              "http.url": "myllm"
            }
          }
        }
      },
      {
        "External/ServiceD": {
          "parent": "Llm/SOMETHING/function",
          "agent_attrs": {
            "exact": {
              "http.url": "serviceD"
            }
          }
        }
      }
    ],
    "unexpected_spans": ["inprocess"]
  },
  {
    "test_name": "partial_granularity_compact",
    "comment": [ "Use transaction from tracer_info.json, with partial granularity set to 'compact'",
      "We should drop the in-process span and keep the rest.",
      "The external span External/B2 under the in-process span should be merged into External/B1.",
      "Their durations should be merged and the merged span should have 2 new attributes: nr.ids and nr.durations.",
      "The non-essential attribute on externalB1 should be dropped"],
    "tracer_info":"tracer_info_standard.json",
    "partial_granularity_type": "compact",
    "expected_spans": [
      {
        "root": {
          "parent": null,
          "agent_attrs": {
            "exact": {
              "nr.pg": true
            }
          }
        }
      },
      {
        "External/ServiceB1": {
          "parent": "root",
          "timestamp": 1766435410010,
          "duration": 0.1,
          "agent_attrs": {
            "exact": {
              "http.url": "serviceB",
              "nr.durations": 0.16
            },
            "expected": [
              "nr.ids",
              "error.class",
              "error.message",
              "error.expected"
            ],
            "unexpected": [
              "non_essential_attr"
            ]
          },
          "user_attrs": {
            "unexpected": ["my_user_attr"]
          }
        }
      },
      {
        "External/ServiceC": {
          "parent": "root",
          "agent_attrs": {
            "exact": {
              "http.url": "serviceC",
              "cloud.account.id": "12345",
              "cloud.platform": "AWS",
              "cloud.region": "US-EAST-1",
              "cloud.resource_id": "67890",
              "db.instance": "MYDB",
              "db.system": "Postgres",
              "http.url": "http://url1/",
              "messaging.destination.name": "dest",
              "messaging.system": "MQS",
              "peer.hostname": "peer",
              "server.address": "server",
              "server.port": 80,
              "span.kind": "SPAN"
            }
          }
        }
      },
      {
        "Llm/SOMETHING/function": {
          "parent": "root",
          "agent_attrs": {
            "exact": {
              "http.url": "myllm"
            }
          }
        }
      },
      {
        "External/ServiceD": {
          "parent": "root",
          "agent_attrs": {
            "exact": {
              "http.url": "serviceD"
            }
          }
        }
      }
    ],
    "unexpected_spans": ["inprocess", "External/ServiceServiceB2"]
  },
  {
    "test_name": "partial_granularity_compact_too_many_nrids",
    "comment": [ "Use transaction from tracer_info.json, with partial granularity set to 'compact'",
      "We should group all the child spans together which should be too many to add all to nr.ids",
      "This should produce a metric called Supportability/Java/PartialGranularity/NrIds/Dropped with the right value"
    ],
    "tracer_info":"tracer_info_compact_too_many.json",
    "partial_granularity_type": "compact",
    "expected_metrics": [
      ["Supportability/Java/PartialGranularity/NrIds/Dropped", 7]
    ],
    "expected_spans": [
      {
        "root": {
          "parent": null,
          "agent_attrs": {
            "exact": {
              "nr.pg": true
            }
          }
        }
      },
      {
        "External/Service1": {
          "parent": "root",
          "agent_attrs": {
            "exact": {
              "http.url": "service",
              "nr.durations": 0.7
            },
            "expected": ["nr.ids"]
          }
        }
      }
    ],
    "unexpected_spans": ["inprocess",
      "External/Service2", "External/Service3", "External/Service4", "External/Service5", "External/Service6", "External/Service7", "External/Service8", "External/Service9", "External/Service10",
      "External/Service11", "External/Service12", "External/Service13", "External/Service14", "External/Service15", "External/Service16", "External/Service17", "External/Service18", "External/Service19", "External/Service20",
      "External/Service21", "External/Service22", "External/Service23", "External/Service24", "External/Service25", "External/Service26", "External/Service27", "External/Service28", "External/Service29", "External/Service30",
      "External/Service31", "External/Service32", "External/Service33", "External/Service34", "External/Service35", "External/Service36", "External/Service37", "External/Service38", "External/Service39", "External/Service40",
      "External/Service41", "External/Service42", "External/Service43", "External/Service44", "External/Service45", "External/Service46", "External/Service47", "External/Service48", "External/Service49", "External/Service50",
      "External/Service51", "External/Service52", "External/Service53", "External/Service54", "External/Service55", "External/Service56", "External/Service57", "External/Service58", "External/Service59", "External/Service60",
      "External/Service61", "External/Service62", "External/Service63", "External/Service64", "External/Service65", "External/Service66", "External/Service67", "External/Service68", "External/Service69", "External/Service70"
    ]
  }
]