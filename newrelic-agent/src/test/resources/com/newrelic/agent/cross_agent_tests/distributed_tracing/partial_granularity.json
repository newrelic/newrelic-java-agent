[
  {
    "test_name": "partial_granularity_reduced",
    "comment": [ "Use transaction from tracer_info.json, with partial granularity set to 'reduced'",
      "We should drop the in-process span and keep the rest.",
      "The external span external_B2 under the in-process span should be re-parented to the root span."],
    "tracer_info":"tracer_info_standard.json",
    "partial_granularity_type": "reduced",
    "expected_spans": [
      {
        "root": {
          "parent": null,
          "agent_attrs": {
            "exact": {
              "nr.pg": true
            }
          }
        }
      },
      {
        "external_B1": {
          "parent": "root",
          "agent_attrs": {
            "exact": {
              "http.url": "serviceB",
              "non_essential_attr": "somevalue",
              "error.class": "errorclass1",
              "error.message": "errormessage1",
              "error.expected": true
            }
          },
          "user_attrs": {
            "exact": {
              "my_user_attr": "my_value"
            }
          }
        }
      },
      {
        "external_B2": {
          "parent": "root",
          "agent_attrs": {
            "exact": {
              "http.url": "serviceB",
              "error.class": "errorclass2",
              "error.message": "errormessage2",
              "error.expected": false
            }
          }
        }
      },
      {
        "external_C": {
          "parent": "root",
          "agent_attrs": {
            "exact": {
              "http.url": "serviceC",
              "cloud.account.id": "12345",
              "cloud.platform": "AWS",
              "cloud.region": "US-EAST-1",
              "cloud.resource_id": "67890",
              "db.instance": "MYDB",
              "db.system": "Postgres",
              "http.url": "http://url1/",
              "messaging.destination.name": "dest",
              "messaging.system": "MQS",
              "peer.hostname": "peer",
              "server.address": "server",
              "server.port": 80,
              "span.kind": "SPAN"
            }
          }
        }
      },
      {
        "Llm/SOMETHING/function": {
          "parent": "root",
          "agent_attrs": {
            "exact": {
              "http.url": "myllm"
            }
          }
        }
      },
      {
        "external_D": {
          "parent": "Llm/SOMETHING/function",
          "agent_attrs": {
            "exact": {
              "http.url": "serviceD"
            }
          }
        }
      }
    ],
    "unexpected_spans": ["inprocess"]
  },
  {
    "test_name": "partial_granularity_essential",
    "comment": [ "Use transaction from tracer_info.json, with partial granularity set to 'essential'",
      "We should drop the in-process span and keep the rest.",
      "The external span external_B2 under the in-process span should be re-parented to the root span.",
      "The non-essential attribute on external_B1 should be dropped"],
    "tracer_info":"tracer_info_standard.json",
    "partial_granularity_type": "essential",
    "expected_spans": [
      {
        "root": {
          "parent": null,
          "agent_attrs": {
            "exact": {
              "nr.pg": true
            }
          }
        }
      },
      {
        "external_B1": {
          "parent": "root",
          "agent_attrs": {
            "exact": {
              "http.url": "serviceB",
              "error.class": "errorclass1",
              "error.message": "errormessage1",
              "error.expected": true
            },
            "unexpected": ["non_essential_attr"]
          },
          "user_attrs": {
            "unexpected": ["my_user_attr"]
          }
        }
      },
      {
        "external_B2": {
          "parent": "root",
          "agent_attrs": {
            "exact": {
              "http.url": "serviceB",
              "error.class": "errorclass2",
              "error.message": "errormessage2",
              "error.expected": false
            }
          }
        }
      },
      {
        "external_C": {
          "parent": "root",
          "agent_attrs": {
            "exact": {
              "http.url": "serviceC",
              "cloud.account.id": "12345",
              "cloud.platform": "AWS",
              "cloud.region": "US-EAST-1",
              "cloud.resource_id": "67890",
              "db.instance": "MYDB",
              "db.system": "Postgres",
              "http.url": "http://url1/",
              "messaging.destination.name": "dest",
              "messaging.system": "MQS",
              "peer.hostname": "peer",
              "server.address": "server",
              "server.port": 80,
              "span.kind": "SPAN"
            }
          }
        }
      },
      {
        "Llm/SOMETHING/function": {
          "parent": "root",
          "agent_attrs": {
            "exact": {
              "http.url": "myllm"
            }
          }
        }
      },
      {
        "external_D": {
          "parent": "Llm/SOMETHING/function",
          "agent_attrs": {
            "exact": {
              "http.url": "serviceD"
            }
          }
        }
      }
    ],
    "unexpected_spans": ["inprocess"]
  },
  {
    "test_name": "partial_granularity_compact",
    "comment": [ "Use transaction from tracer_info.json, with partial granularity set to 'compact'",
      "We should drop the in-process span and keep the rest.",
      "The external span external_B2 under the in-process span should be merged into external_B1.",
      "Their durations should be merged and the merged span should have 2 new attributes: nr.ids and nr.durations.",
      "The non-essential attribute on externalB1 should be dropped"],
    "tracer_info":"tracer_info_standard.json",
    "partial_granularity_type": "compact",
    "expected_spans": [
      {
        "root": {
          "parent": null,
          "agent_attrs": {
            "exact": {
              "nr.pg": true
            }
          }
        }
      },
      {
        "external_B1": {
          "parent": "root",
          "timestamp": 1766435410010,
          "duration": 0.1,
          "agent_attrs": {
            "exact": {
              "http.url": "serviceB",
              "nr.durations": 0.16
            },
            "expected": [
              "nr.ids",
              "error.class",
              "error.message",
              "error.expected"
            ],
            "unexpected": [
              "non_essential_attr"
            ]
          },
          "user_attrs": {
            "unexpected": ["my_user_attr"]
          }
        }
      },
      {
        "external_C": {
          "parent": "root",
          "agent_attrs": {
            "exact": {
              "http.url": "serviceC",
              "cloud.account.id": "12345",
              "cloud.platform": "AWS",
              "cloud.region": "US-EAST-1",
              "cloud.resource_id": "67890",
              "db.instance": "MYDB",
              "db.system": "Postgres",
              "http.url": "http://url1/",
              "messaging.destination.name": "dest",
              "messaging.system": "MQS",
              "peer.hostname": "peer",
              "server.address": "server",
              "server.port": 80,
              "span.kind": "SPAN"
            }
          }
        }
      },
      {
        "Llm/SOMETHING/function": {
          "parent": "root",
          "agent_attrs": {
            "exact": {
              "http.url": "myllm"
            }
          }
        }
      },
      {
        "external_D": {
          "parent": "Llm/SOMETHING/function",
          "agent_attrs": {
            "exact": {
              "http.url": "serviceD"
            }
          }
        }
      }
    ],
    "unexpected_spans": ["inprocess", "external_B2"]
  },
  {
    "test_name": "partial_granularity_compact_too_many_nrids",
    "comment": [ "Use transaction from tracer_info.json, with partial granularity set to 'compact'",
      "We should group all the child spans together which should be too many to add all to nr.ids",
      "This should produce a metric called Supportability/Java/PartialGranularity/NrIds/Dropped with the right value"
    ],
    "tracer_info":"tracer_info_compact_too_many.json",
    "partial_granularity_type": "compact",
    "expected_metrics": [
      ["Supportability/Java/PartialGranularity/NrIds/Dropped", 7]
    ],
    "expected_spans": [
      {
        "root": {
          "parent": null,
          "agent_attrs": {
            "exact": {
              "nr.pg": true
            }
          }
        }
      },
      {
        "external1": {
          "parent": "root",
          "agent_attrs": {
            "exact": {
              "http.url": "service",
              "nr.durations": 0.7
            },
            "expected": ["nr.ids"]
          }
        }
      }
    ],
    "unexpected_spans": ["inprocess",
      "ext2", "ext3", "ext4", "ext5", "ext6", "ext7", "ext8", "ext9", "ext10",
      "ext11", "ext12", "ext13", "ext14", "ext15", "ext16", "ext17", "ext18", "ext19", "ext20",
      "ext21", "ext22", "ext23", "ext24", "ext25", "ext26", "ext27", "ext28", "ext29", "ext30",
      "ext31", "ext32", "ext33", "ext34", "ext35", "ext36", "ext37", "ext38", "ext39", "ext40",
      "ext41", "ext42", "ext43", "ext44", "ext45", "ext46", "ext47", "ext48", "ext49", "ext50",
      "ext51", "ext52", "ext53", "ext54", "ext55", "ext56", "ext57", "ext58", "ext59", "ext60",
      "ext61", "ext62", "ext63", "ext64", "ext65", "ext66", "ext67", "ext68", "ext69", "ext70"
    ]
  }
]